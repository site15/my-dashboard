# my-dashboard

Этот проект был создан с помощью [Analog](https://analogjs.org), полнофункционального мета-фреймворка для Angular.

## Демо

Приложение развернуто и доступно по адресу: https://site15-my-dashboard.vercel.app

## Настройка

Выполните `npm install` чтобы установить зависимости приложения.

## Сообщество

Присоединяйтесь к нашему Telegram-чату разработчиков для обсуждений, обновлений и поддержки:
- [Telegram-чат разработчиков](https://t.me/site15_community)

## Уведомления о релизах

Информация о релизах и обновлениях автоматически публикуется в нашем Telegram-чате сообщества:
- [Уведомления о релизах в Telegram](https://t.me/site15_community/3)

## Настройка базы данных

Этот проект использует базу данных PostgreSQL. Мы рекомендуем использовать [Neon](https://neon.tech/) для облачного хостинга, так как он предоставляет щедрый бесплатный тариф и не засыпает, как некоторые другие бесплатные варианты.

Чтобы настроить базу данных:

1. Создайте базу данных в облаке с помощью [Neon](https://neon.tech/)
2. Скопируйте строку подключения в ваш файл `.env`:
   ```
   MY_DASHBOARD_DATABASE_POSTGRES_URL=ваша_строка_подключения_neon_здесь
   ```

Альтернативные варианты баз данных:
- [Supabase](https://supabase.com/) - Может засыпать на бесплатном тарифе
- [CockroachCloud](https://www.cockroachlabs.com/) - Имеет пробный период

Neon рекомендуется, потому что он обеспечивает хороший баланс функций, производительности и стоимости для разработки.

## Миграции базы данных

Миграции базы данных генерируются на основе изменения схемы Prisma и применяются с локального компьютера разработчика:

1. Измените файл `prisma/schema.prisma`, чтобы внести изменения в структуру вашей базы данных
2. Выполните `./node_modules/.bin/prisma migrate dev` для генерации и применения миграций локально
3. Зафиксируйте сгенерированные файлы миграций в системе контроля версий

Примечание: Миграции должны применяться локально разработчиком и не применяются автоматически Vercel во время развертывания.

## Настройка Prisma

Этот проект использует Prisma в качестве ORM. После настройки базы данных:

1. Установите `dotenv` и добавьте `import "dotenv/config";` в ваш файл `prisma.config.ts` для загрузки переменных окружения из `.env`:
   ```typescript
   import "dotenv/config";
   import { defineConfig, env } from "prisma/config";
   
   export default defineConfig({
     // ... существующая конфигурация
   });
   ```

2. Определите ваши модели в файле `prisma/schema.prisma`.

3. Выполните `./node_modules/.bin/prisma migrate dev` для миграции вашей базы данных.

Примечание: Переменные окружения, объявленные в файле `.env`, НЕ загружаются автоматически Prisma. Вы должны явно импортировать `dotenv/config`.

## Зеркало движков Prisma

При установке зависимостей Node.js вы можете столкнуться с проблемами блокировки движков Prisma брандмауэрами или региональными ограничениями. Чтобы решить эту проблему, установите следующую переменную окружения перед установкой зависимостей:

```bash
export PRISMA_ENGINES_MIRROR=https://registry.npmmirror.com/-/binary/prisma
```

Это перенаправит загрузку движков Prisma на зеркало, которое более доступно из определенных регионов.

## Аутентификация через Telegram

Это приложение использует аутентификацию через Telegram с методом перенаправления и проверкой хэша на стороне сервера. Реализация следует подходу, описанному в [Telegram Login with Node.js](https://edisonchee.com/writing/telegram-login-with-node.js/).

Существует несколько способов реализации входа через Telegram:
1. **Telegram Login Widget** - Предоставляет кнопку "Log in with Telegram", которая запускает всплывающее окно для потока OAuth
2. **Seamless Web Bots** - Позволяет войти, нажав на кнопку встроенного клавиатуры от бота
3. **Метод перенаправления URL** - Использует data-auth-url вместо data-onauth для получения данных на сервере

Это приложение использует метод перенаправления URL. Поток аутентификации работает следующим образом:
1. Пользователь нажимает кнопку входа через Telegram на веб-сайте
2. Пользователь перенаправляется в Telegram для аутентификации
3. После успешной аутентификации Telegram перенаправляет обратно в приложение с данными пользователя и хэшем
4. Сервер проверяет хэш, чтобы убедиться, что данные подлинные, используя криптографическую проверку:
   - Создается хэш секрета (токен бота), известного как приложению, так и Telegram
   - Параметры пользовательских данных сортируются и создается строка проверки данных
   - Выполняется криптографическая хэш-функция над строкой проверки данных и секретом
   - Рассчитанный хэш сравнивается с хэшем, полученным от Telegram
5. Если проверка прошла успешно, данные пользователя сохраняются в базе данных

Поскольку Telegram требует домен для работы этой аутентификации, вам нужно использовать туннелирующий сервис, такой как [ngrok](https://ngrok.com/) или [tuna](https://tuna.am/) для локальной разработки. В текущем проекте используется [tuna](https://tuna.am/) для этой цели.

Для использования tuna при локальной разработке с аутентификацией через Telegram:
```bash
tuna http 5173
```

Эта команда создаст туннель к вашему локальному серверу разработки, работающему на порту 5173, предоставляя вам публичный URL, который можно использовать с системой аутентификации Telegram.

## Развертывание на Vercel

Этот проект можно развернуть на Vercel. Vercel имеет нативную интеграцию с Neon, что упрощает подключение вашей базы данных:

1. Подключите ваш репозиторий GitHub к Vercel
2. Во время настройки Vercel автоматически обнаружит переменные окружения
3. Добавьте ваш `MY_DASHBOARD_DATABASE_POSTGRES_URL` как переменную окружения в настройках проекта Vercel

Vercel настроен на автоматическое прослушивание изменений и повторное развертывание сайта при каждом отправке изменений в репозиторий.

## Разработка

Выполните `npm start` для запуска сервера разработки. Перейдите по адресу `http://localhost:5173/`. Приложение автоматически перезагружается при изменении исходных файлов.

## Сборка

Выполните `npm run build` для сборки клиент/сервер проекта. Артефакты сборки клиента расположены в каталоге `dist/analog/public`. Сервер для артефактов сборки API расположен в каталоге `dist/analog/server`.

## Тестирование

Выполните `npm run test` для запуска модульных тестов с помощью [Vitest](https://vitest.dev).

## Устранение неполадок

### Ошибка "Bot domain invalid" при входе через Telegram

Если кнопка входа через Telegram отображает "Bot domain invalid" вместо диалога входа, вам необходимо настроить домен вашего бота:

1. Запустите туннелирующий сервис с помощью команды:
   ```bash
   tuna http 5173
   ```
   
2. После выполнения команда отобразит публичный URL (пример: `https://3zpmpk-46-191-177-220.ru.tuna.am`)

3. Возьмите этот URL и установите его как домен вашего бота через BotFather:
   - Откройте чат с [@BotFather](https://t.me/BotFather) в Telegram
   - Отправьте команду `/setdomain`
   - Выберите вашего бота из списка
   - Введите публичный URL, предоставленный командой tuna

Эта настройка необходима, потому что Telegram требует действительный домен для механизма аутентификации, чтобы он работал правильно во время локальной разработки.

### Ошибка "Blocked request" с сервером разработки Vite

Если вы видите сообщение об ошибке типа `Blocked request. This host ("3zpmpk-46-191-177-220.ru.tuna.am") is not allowed.` или похожее сообщение при доступе к вашему приложению через туннель tuna, это означает, что вам нужно добавить имя домена в конфигурацию Vite.

Сервер разработки Vite имеет функцию безопасности, которая блокирует запросы с неизвестных хостов. При использовании туннелирующего сервиса, такого как tuna, вам нужно явно разрешить сгенерированный домен.

Это уже настроено в файле [vite.config.ts](vite.config.ts) со следующей конфигурацией:

```javascript
server: {
  allowedHosts: ['3zpmpk-46-191-177-220.ru.tuna.am', 'localhost'],
}
```

Если вы сталкиваетесь с этой ошибкой с другим доменом, вы можете добавить его в массив `allowedHosts` в файле [vite.config.ts](vite.config.ts).

## Сообщество

- Посетите и поставьте звезду [репозиторию на GitHub](https://github.com/analogjs/analog)
- Присоединяйтесь к [Discord](https://chat.analogjs.org)
- Подписывайтесь на нас в [Twitter](https://twitter.com/analogjs)
- Станьте [спонсором](https://github.com/sponsors/brandonroberts)