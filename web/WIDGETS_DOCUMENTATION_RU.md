# Документация по виджетам проекта "Мой Дашборд"

## Обзор

В этом документе описана реализация виджетов в проекте "Мой Дашборд". В настоящее время реализовано несколько виджетов, включая виджет отслеживания привычек (Habits Widget), виджет часов (Clock Widget), виджет календаря (Calendar Widget) и виджет счётчика (Counter Widget), которые позволяют пользователям отслеживать свои ежедневные привычки, просматривать время и дату, а также вести счётчики с историей изменений.

## Реализованные виджеты



### Виджет отслеживания привычек (Habits Widget)

Виджет отслеживания привычек позволяет пользователям отслеживать свои ежедневные привычки и активности с помощью интерактивного интерфейса.

#### Особенности виджета:

1. **Отображение на дашборде**:
   - Компактное представление с иконками первых 3 привычек
   - Прогресс-бары для каждой привычки
   - Счетчики текущих значений
   - Возможность раскрытия полного интерфейса по клику

2. **Модальное окно**:
   - Вкладки: "Счетчики" и "История"
   - Интерактивные кнопки +/- для увеличения/уменьшения значений
   - Визуализация прогресса с цветовой индикацией
   - История потребления с временнными метками

3. **Поддерживаемые типы привычек**:
   - Вода (droplet)
   - Еда (utensils)
   - Медикаменты (pill)
   - Упражнения (dumbbell)
   - Кофе (coffee)
   - Стакан воды (glass-water)
   - Яблоко (apple)
   - Вес (weight)
   - Пульс (heart-pulse)
   - Осознанность (brain)
   - Чтение (book)
   - Музыка (music)
   - ТВ/Фильмы (tv)
   - Игры (gamepad)
   - Сон (bed)
   - Солнце (sun)
   - Луна (moon)
   - Звезда (star)
   - Улыбка (smile)
   - Активность (activity)

4. **Цветовые схемы**:
   - Синий (blue)
   - Оранжевый (orange)
   - Фиолетовый (purple)
   - Зеленый (green)
   - Красный (red)
   - Желтый (yellow)
   - Розовый (pink)

#### Техническая реализация:

##### Файлы реализации:

- `web/src/server/widgets/habits-widget.ts` - Основной класс виджета и шаблон отображения
- `web/src/server/widgets/habits-widget.utils.ts` - Вспомогательные функции на стороне клиента

##### Структура данных:

```typescript
interface HabitsWidgetItem {
  id: string;
  name: string;
  icon: string;
  color: string;
  minValue: number;
  maxValue: number;
  history: Array<{
    id: number;
    time: string;
  }>;
}
```

##### Основные функции:

- `showHabitsModal(modalId)` - Отображение модального окна
- `hideHabitsModal(modalId)` - Скрытие модального окна
- `addItem(itemId)` - Увеличение значения привычки
- `removeItem(itemId)` - Уменьшение значения привычки
- `switchHabitsTab(modalId, tabName)` - Переключение между вкладками
- `renderConsumptionList(modalId)` - Отображение истории потребления

#### Интеграция с системой:

Виджет интегрирован с общей системой виджетов проекта и использует следующие компоненты:

- Zod схемы для валидации данных
- Formly для конфигурации формы настройки виджета
- Lucide Icons для иконок
- Tailwind CSS для стилизации

#### Пример конфигурации виджета:

```json
{
  "type": "habits",
  "name": "Daily Habits",
  "items": [
    {
      "id": "water",
      "name": "Water",
      "icon": "droplet",
      "color": "blue",
      "minValue": 0,
      "maxValue": 8,
      "history": []
    }
  ]
}
```

### Виджет часов (Clock Widget)

Виджет часов отображает текущее время с настраиваемым часовым поясом и названием.

#### Особенности виджета:

1. **Отображение на дашборде**:
   - Показывает текущее время в формате ЧЧ:ММ:СС
   - Настраиваемый часовой пояс
   - Настраиваемое имя/название отображения
   - Поддержка 12/24 часового формата

2. **Параметры настройки**:
   - Выбор часового пояса
   - Отображаемое имя
   - Выбор формата 12/24 часа
   - Пользовательские параметры стилизации

#### Техническая реализация:

##### Файлы реализации:
- `web/src/server/widgets/clock-widget.ts` - Основной класс виджета и шаблон отображения
- `web/src/server/widgets/clock-widget.utils.ts` - Вспомогательные функции на стороне клиента

##### Структура данных:
```typescript
interface ClockWidgetOptions {
  timeZone: string;
  name: string;
  format24Hour: boolean;
}
```

### Виджет календаря (Calendar Widget)

Виджет календаря отображает текущую дату с настраиваемым месяцем и числом.

#### Особенности виджета:

1. **Отображение на дашборде**:
   - Показывает текущую дату с днем, месяцем и годом
   - Настраиваемый фиксированный месяц и число
   - Отображение дня недели
   - Полное название месяца

2. **Параметры настройки**:
   - Выбор фиксированного месяца
   - Выбор фиксированной даты
   - Пользовательские параметры стилизации

#### Техническая реализация:

##### Файлы реализации:
- `web/src/server/widgets/calendar-widget.ts` - Основной класс виджета и шаблон отображения
- `web/src/server/widgets/calendar-widget.utils.ts` - Вспомогательные функции на стороне клиента

##### Структура данных:
```typescript
interface CalendarWidgetOptions {
  month: number;
  date: number;
  fixedDate: boolean;
}
```

### Виджет графиков курсов валют (Currency Charts Widget)

Виджет графиков курсов валют отображает интерактивные финансовые графики для криптовалютных и форекс пар с использованием **реальных данных из API Yahoo Finance**.

#### Особенности виджета:

1. **Двойная система отображения**:
   - **Панель дашборда**: Показывает настраиваемое количество графиков (по умолчанию: 3)
   - **Модальный просмотр**: Отображает все настроенные валютные пары детально
   - Кнопка максимизации для просмотра всех графиков

2. **Поддержка множества валют**:
   - **Криптовалюты**: BTC/USD, ETH/USD, BNB/USD, ADA/USD, SOL/USD, XRP/USD, DOT/USD, DOGE/USD, AVAX/USD, MATIC/USD
   - **Форекс**: EUR/USD, GBP/USD, USD/JPY, USD/CAD, AUD/USD, USD/CHF, NZD/USD, USD/SGD
   - Пользовательские названия для каждой пары

3. **Функции графиков**:
   - Профессиональная реализация Chart.js
   - Стилизация точек с круглыми маркерами и белыми границами
   - Цветовое кодирование зеленый/красный в зависимости от движения цены
   - Интерактивные подсказки с точными ценами
   - Плавные изогнутые линии
   - Адаптивный дизайн для всех размеров экранов

4. **Реальные данные в реальном времени**:
   - **Интеграция с API Yahoo Finance**: Получение актуальных рыночных данных
   - **Автоматическое преобразование символов**: Конвертация BTC/USD → BTC-USD, EUR/USD → EURUSD=X
   - **Обновление каждые 30 секунд**: Автоматическое периодическое обновление данных
   - **Умный запасной вариант**: Использование имитационных данных при недоступности API
   - **Обработка ошибок**: Гладкое восстановление при сбоях API

5. **Параметры настройки**:
   - Периоды графиков: 1ч, 4ч, 1д, 1н, 1м
   - Лимит графиков на дашборде (1-6 графиков)
   - Переключатель объемных баров
   - Пользовательское имя виджета
   - Индивидуальные названия пар

#### Техническая реализация:

##### Файлы реализации:
- `web/src/server/widgets/currency-widget.ts` - Основной класс виджета с Zod схемами и интеграцией Chart.js
- `web/src/server/widgets/currency-widget.utils.ts` - Вспомогательные утилиты на стороне клиента и функции окна
- `web/src/server/services/yahoo-finance-api.ts` - Сервис API Yahoo Finance для получения данных в реальном времени

#### Интеграция с системой:

Виджет интегрирован с общей системой виджетов и использует:
- Chart.js v4.5.1 для профессионального рендеринга графиков
- Zod схемы для валидации данных
- Formly для формы настройки виджета
- Lucide Icons для элементов интерфейса
- Tailwind CSS для стилизации
- **API Yahoo Finance** для получения рыночных данных в реальном времени
- **Ограничение частоты запросов**: 50 запросов в минуту на пользователя/сессию
- **Реализация ограничения частоты**: Использует алгоритм скользящего окна с хранением в памяти
- **Приоритет идентификации**: ID сессии → заголовок x-session-id → IP адрес → 'unknown'
- **Обработка ошибок**: Возвращает ошибку TOO_MANY_REQUESTS TRPC с информацией о повторной попытке
- **Автоматическая очистка**: Истекшие записи ограничения частоты очищаются каждую минуту
- Периодические обновления данных (каждые 30 секунд)
- Умный запасной вариант на имитационные данные при сбоях API
- Стилизация точек согласно официальным примерам Chart.js


## API Финансовых Данных

API финансовых данных предоставляет информацию о курсах валют в реальном времени через TRPC эндпоинты со встроенной защитой от превышения частоты запросов.

### Эндпоинты API

#### `finance.getCurrencyData`
- **Назначение**: Получение данных по нескольким валютным парам
- **Входные данные**: Массив символов, период, опциональный интервал
- **Выходные данные**: Массив данных о валютах с информацией для графиков
- **Ограничение частоты**: Да (50 запросов/минуту)

#### `finance.getSingleCurrencyData`
- **Назначение**: Получение данных по одной валютной паре
- **Входные данные**: Символ, период, опциональный интервал
- **Выходные данные**: Подробные данные по одной паре
- **Ограничение частоты**: Да (50 запросов/минуту)

### Детали Ограничения Частоты Запросов

- **Алгоритм**: Скользящее окно с интервалами по 1 минуте
- **Лимит**: 50 запросов в минуту на пользователя/сессию
- **Идентификация**: ID сессии → заголовок x-session-id → IP адрес
- **Ответ при ошибке**: `TOO_MANY_REQUESTS` с информацией о времени повторной попытки
- **Хранение**: Map в памяти с автоматической очисткой

### Файлы Реализации

- `web/src/server/trpc/routers/finance.ts` - Основной маршрутизатор финансов с ограничением частоты
- `web/src/server/services/yahoo-finance-api.ts` - Сервис получения данных от Yahoo Finance
- `web/src/server/middleware/rate-limit.ts` - Универсальные утилиты ограничения частоты

### Обработка Ошибок

При превышении лимита частоты запросов клиенты получают:
```json
{
  "code": "TOO_MANY_REQUESTS",
  "message": "Превышен лимит запросов. Максимум 50 запросов в минуту разрешено. Попробуйте снова через X секунд."
}
```

### Рекомендации

1. Кэшируйте ответы когда это возможно для уменьшения количества вызовов API
2. Реализуйте экспоненциальную задержку для логики повторных попыток
3. Отслеживайте заголовки ограничения частоты в ответах
4. Корректно обрабатывайте ошибки ограничения частоты в клиентских приложениях

## План развития виджетов

### Ближайшие задачи:

1. Улучшение системы настройки виджетов
2. Добавление возможности сохранения состояния виджетов в базе данных
3. Реализация системы логирования изменений виджетов

### Долгосрочные цели:

1. Создание расширяемой системы виджетов с возможностью добавления новых типов
2. Реализация механизма обмена виджетами между пользователями
3. Добавление системы уведомлений для виджетов
4. Создание мобильного интерфейса для взаимодействия с виджетами

## Решение проблем

### Известные проблемы:

1. Некоторые цветовые классы Tailwind CSS не генерируются автоматически для пользовательских цветов
2. Для корректной работы некоторых функций требуется глобальная область видимости

### Рекомендации:

1. При добавлении новых цветов убедитесь, что они корректно отображаются в Tailwind CSS
2. При разработке новых виджетов следуйте установленным паттернам реализации
3. Используйте предоставленные утилиты для работы с DOM вместо прямого обращения к элементам
